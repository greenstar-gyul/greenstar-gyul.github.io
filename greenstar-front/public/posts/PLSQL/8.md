# PL/SQL - (2)
## 기본 문법
```SQL
--Anonymous Block. 그냥 한 번 실행하고 끝나는 블럭
DECLARE
    변수1 데이터타입;
    변수2 데이터타입;
BEGIN
    SELECT 컬럼1, 컬럼2
    INTO 변수1, 변수2
    FROM 테이블;
END;
/
```
### 주의사항
1. SELECT 결과는 항상 하나의 행
```sql
DECLARE
    v_ename employees.last_name%TYPE;
BEGIN
    SELECT last_name
    INTO v_ename
    FROM employees
    WHERE department_id = 10;

    DBMS_OUTPUT.PUT_LINE('사원이름: ' || v_ename);
END;
/
```
```
[output]
사원이름: Whalen
```
  - 결과가 여러 행일 경우
```sql
DECLARE
    v_ename employees.last_name%TYPE;
BEGIN
    SELECT last_name
    INTO v_ename
    FROM employees; -- 조회되는 사원이 여러명

    DBMS_OUTPUT.PUT_LINE('사원이름: ' || v_ename);
END;
/
```
```
[output]
ORA-01422: exact fetch returns more than requested number of rows
```
  - 결과가 없을 경우
```sql
DECLARE
    v_ename employees.last_name%TYPE;
BEGIN
    SELECT last_name
    INTO v_ename
    FROM employees
    WHERE department_id = 100000; -- 부서번호 100000에 해당하는 사원 없음

    DBMS_OUTPUT.PUT_LINE('사원이름: ' || v_ename);
END;
/
```
```
[output]
ORA-01403: no data found
```

2. SELECT절의 컬럼 수 = INTO절의 변수 수
```sql
DECLARE
    v_eid employees.employee_id%TYPE;
    v_ename employees.last_name%TYPE;
BEGIN
    SELECT employee_id, last_name
    INTO v_eid, v_ename
    FROM employees
    WHERE employee_id = 100;

    DBMS_OUTPUT.PUT_LINE('사원번호: ' || v_eid);
    DBMS_OUTPUT.PUT_LINE('사원이름: ' || v_ename);
END;
/
```
```
[output]
사원번호: 100
사원이름: King
```
  - SELECT절의 컬럼 수 > INTO절의 변수 수
```sql
DECLARE
    v_eid employees.employee_id%TYPE;
    v_ename employees.last_name%TYPE;
BEGIN
    SELECT employee_id, last_name
    INTO v_eid      -- SELECT절의 컬럼 수 > INTO절의 변수 수
    FROM employees
    WHERE employee_id = 100;

    DBMS_OUTPUT.PUT_LINE('사원번호: ' || v_eid);
    DBMS_OUTPUT.PUT_LINE('사원이름: ' || v_ename);
END;
/
```
```
[output]
ORA-00947: not enough values
```
  - SELECT절의 컬럼 수 < INTO절의 변수 수
```sql
DECLARE
    v_eid employees.employee_id%TYPE;
    v_ename employees.last_name%TYPE;
BEGIN
    SELECT employee_id
    INTO v_eid, v_ename      -- SELECT절의 컬럼 수 < INTO절의 변수 수
    FROM employees
    WHERE employee_id = 100;

    DBMS_OUTPUT.PUT_LINE('사원번호: ' || v_eid);
    DBMS_OUTPUT.PUT_LINE('사원이름: ' || v_ename);
END;
/
```
```
[output]
ORA-00947: not enough values
```
3. INTO절에 사용된 변수의 데이터타입 크기는 항상 SELECT절의 컬럼 데이터타입 크기보다 크거나 같아야한다.

## 커서(Cursor)
- SQL 문을 실행했을 때 해당 SQL문을 처리하는 정보를 저장한 메모리 공간
- 쿼리 결과 집합(Result Set)을 한 행(row)씩 순차적으로 접근하고 처리하기 위해 메모리에 임시로 저장된 위치 포인터를 사용하는 SQL 제어 구조
- 명시적 커서/묵시적 커서

SQL%ROWCOUNT | 가장 최근의 SQL 문이 적용된 행의 개수(정수 값)
```sql
BEGIN
    DELETE FROM employees
    WHERE employee_id = 0;
    
    DBMS_OUTPUT.PUT_LINE('결과: ' || SQL%ROWCOUNT || '개 행이(가) 삭제되었습니다.');
    
    DELETE FROM employees
    WHERE employee_id = 100;
    
    DBMS_OUTPUT.PUT_LINE('결과: ' || SQL%ROWCOUNT || '개 행이(가) 삭제되었습니다.');
    ROLLBACK;
END;
/
```
```
[output]
결과: 0개 행이(가) 삭제되었습니다.
결과: 1개 행이(가) 삭제되었습니다.
```

## 조건문(IF문)
```sql
IF condition THEN
    statements;
[ELSIF condition THEN
    statements;]
[ELSE
    statements;]
END IF;
```
- ELSE IF가 아니라 ELSIF인 점에 유의

- 예시
```sql
DECLARE
    v_fruits VARCHAR2(10) := 'Banana';
BEGIN
    IF v_fruits = 'Apple' THEN
        DBMS_OUTPUT.PUT_LINE('사과입니다.');
    END IF;
    
    IF v_fruits = 'Apple' THEN
        DBMS_OUTPUT.PUT_LINE('사과입니다.');
    ELSE
        DBMS_OUTPUT.PUT_LINE('사과가 아닙니다.');
    END IF;
    
    IF v_fruits = 'Apple' THEN
        DBMS_OUTPUT.PUT_LINE('사과입니다.');
    ELSIF v_fruits = 'Banana' THEN
        DBMS_OUTPUT.PUT_LINE('바나나입니다.');
    ELSE
        DBMS_OUTPUT.PUT_LINE('사과가 아닙니다.');
    END IF;
END;
/
```
```
[output]
사과가 아닙니다.
바나나입니다.
```

## 반복문(LOOP문)
- 기본 LOOP
  - 일단 반복하는 전제로 사용
  - 사용법
```SQL
BEGIN
    LOOP
        실행문                        -- EXIT 지정하지 않으면 무한루프. 
                                      -- buffer overflow 발생.

        EXIT [WHEN 루프 종료 조건식]; -- 종료 조건식이 TRUE이면 반복문 종료.
                                      -- WHEN절 지정 안 하면 1번만 실행됨.
                                      -- java,js의 반복 조건과 달리, 종료 조건임!!
    END LOOP;
END;
```
  - 예시1
```SQL
-- Hello! 5번 출력하기
DECLARE
    v_count NUMBER(1) := 0; -- 반복문을 제어할 변수
BEGIN
    LOOP
        DBMS_OUTPUT.PUT_LINE('Hello!');
        v_count := v_count + 1;
        EXIT WHEN v_count >= 5; -- v_count가 5 이상이 되면 반복문 종료!
    END LOOP;
END;
/
```
```
[output]
Hello!
Hello!
Hello!
Hello!
Hello!
```
  - 예시2
```SQL
-- 정수 1~10까지 합을 LOOP로 구하기
DECLARE
    v_count NUMBER(2) := 0; -- 반복문을 제어할 변수
    v_sum NUMBER(2) := 0;
BEGIN
    LOOP
        v_count := v_count + 1;
        v_sum := v_sum + v_count;
        EXIT WHEN v_count >= 10; -- v_count가 11 이상이 되면 반복문 종료!
    END LOOP;
    DBMS_OUTPUT.PUT_LINE(v_sum);
END;
/
```
```
[output]
55
```
- FOR LOOP

- WHILE LOOP
